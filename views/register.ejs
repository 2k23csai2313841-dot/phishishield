<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PhishShield - Create Account</title>
    <link rel="stylesheet" href="/style2.css" />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 50%,
          #f093fb 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      /* Animated background */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(255, 255, 255, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(255, 255, 255, 0.05) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      .login_and_register_logo {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
      }

      .logo {
        height: 50px;
        width: auto;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
      }

      .auth-container {
        width: 100%;
        max-width: 500px;
        padding: 20px;
        position: relative;
        z-index: 1;
      }

      .auth-box {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 50px 40px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideUp 0.6s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 12px;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .form > p:first-of-type {
        text-align: center;
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 30px;
      }

      .input-group {
        margin-bottom: 16px;
      }

      .input-group input {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #f7fafc;
        font-family: inherit;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .input-group input::placeholder {
        color: #a0aec0;
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 24px 0;
      }

      .register-btn {
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .register-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .register-btn:active:not(:disabled) {
        transform: translateY(0);
      }

      .register-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .register-btn[style*="background: linear-gradient(45deg"] {
        background: linear-gradient(
          45deg,
          rgb(107, 205, 151),
          rgb(2, 254, 36)
        ) !important;
        margin-bottom: 12px;
      }

      .already-have-account {
        text-align: center;
        color: #718096;
        font-size: 0.95rem;
        margin-top: 16px;
      }

      .toggle-form {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s ease;
      }

      .toggle-form:hover {
        color: #764ba2;
        text-decoration: underline;
      }

      .message_center_account {
        margin-top: 16px;
        text-align: center;
        min-height: 24px;
      }

      .message_center_account p {
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message_center_account p.error {
        background: rgba(245, 101, 101, 0.1);
        color: #e53e3e;
        border: 1px solid #fc8181;
      }

      .message_center_account p.success {
        background: rgba(72, 187, 120, 0.1);
        color: #22543d;
        border: 1px solid #9ae6b4;
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        background: white;
        padding: 14px 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: toastSlideIn 0.3s ease;
      }

      @keyframes toastSlideIn {
        from {
          opacity: 0;
          transform: translateX(400px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes toastSlideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(400px);
        }
      }

      .toast.removing {
        animation: toastSlideOut 0.3s ease;
      }

      .toast.success {
        background: #f0fdf4;
        border-left: 4px solid #22c55e;
      }

      .toast.error {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
      }

      .toast.info {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
      }

      .toast.success .toast-icon {
        color: #22c55e;
      }

      .toast.error .toast-icon {
        color: #ef4444;
      }

      .toast.info .toast-icon {
        color: #3b82f6;
      }

      .toast-icon {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .toast-message {
        color: #1f2937;
        font-size: 0.95rem;
        font-weight: 500;
      }

      @media (max-width: 480px) {
        .auth-box {
          padding: 35px 25px;
        }

        .form h1 {
          font-size: 1.5rem;
        }

        .auth-container {
          max-width: 100%;
        }

        .toast {
          min-width: calc(100% - 40px);
          right: 20px;
          left: 20px;
        }

        .input-group input {
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="login_and_register_logo">
      <img class="logo" src="/image/logo.png" alt="logo" />
    </div>

    <div class="auth-container">
      <div class="auth-box">
        <div class="form register-form">
          <h1>Create Account</h1>
          <p>Join PhishShield and protect your digital assets</p>
          <form id="register-form" method="POST" action="/register">
            <div class="input-group">
              <input
                type="text"
                id="new-username"
                name="username"
                placeholder="Enter your username"
                required
              />
            </div>
            <div class="input-group">
              <input
                type="email"
                id="email"
                name="email"
                placeholder="Enter your email"
                required
              />
            </div>
            <div class="input-group">
              <input
                type="password"
                id="new-password"
                name="password"
                placeholder="Create a password"
                required
              />
            </div>
            <div class="input-group">
              <input
                type="password"
                id="confirm-password"
                name="confirm_password"
                placeholder="Confirm password"
                required
              />
            </div>

            <div class="input-group">
              <input
                type="text"
                id="code"
                name="code"
                placeholder="Enter verification code"
                required
              />
            </div>

            <button
              type="button"
              id="getCodeBtn"
              class="register-btn"
              style="
                background: linear-gradient(
                  45deg,
                  rgb(107, 205, 151),
                  rgb(2, 254, 36)
                );
              "
            >
              ðŸ“§ Get Verification Code
            </button>

            <div class="action-buttons">
              <button type="submit" class="register-btn">Create Account</button>
            </div>

            <p class="already-have-account">
              Already have an account?
              <a href="/login" class="toggle-form">Login here</a>
            </p>
            <div class="message_center_account">
              <p id="register-message"></p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
      // Toast notification system
      function showToast(message, type = "success") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        let icon;
        if (type === "success") icon = "âœ“";
        else if (type === "error") icon = "âœ•";
        else icon = "â„¹";

        toast.innerHTML = `
          <span class="toast-icon">${icon}</span>
          <span class="toast-message">${message}</span>
        `;

        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("removing");
          setTimeout(() => toast.remove(), 300);
        }, 3500);
      }

      let globalemail;
      const a = [
        1234, 8988, 2332, 223, 3489, 6721, 9154, 4820, 7391, 5602, 8417, 2935,
        6748, 9182, 4376, 8093, 5264, 7629, 1845, 9501, 3648, 7032, 8456, 1927,
        6193, 7408, 8251, 9037, 4826, 6579, 3182, 7945, 5607, 8724, 2398, 6812,
        9053, 7419, 3642, 8205, 5391, 6784, 9132, 4528, 7963, 2841, 6375, 9821,
        7504, 3159, 4682, 9027, 5941, 8176, 2634, 7492, 8365, 9218, 4712, 8369,
        2905, 7148, 9632, 5087, 6274, 8195, 3746, 9510, 4269, 7853, 6024, 8397,
        9172, 5482, 7631, 2948, 6809, 8306,
      ];

      function getRandomValue(arr) {
        const randomIndex = Math.floor(Math.random() * arr.length);
        return arr[randomIndex];
      }

      let generated_code = null;

      function createOtpHtmlTemplate({ email, otp }) {
        const currentYear = new Date().getFullYear();
        const sentTime = new Date().toLocaleString("en-US", {
          hour: "numeric",
          minute: "numeric",
          hour12: true,
        });

        return `
  <div style="font-family:Poppins,Arial,sans-serif;background:#f4f7f6;padding:20px;">
    <div style="max-width:500px;margin:auto;background:#fff;border-radius:12px;border:1px solid #e5e5e5;overflow:hidden;">
      <div style="background:#f8f9fa;padding:40px;text-align:center;border-bottom:1px solid #dee2e6;">
        <img src="https://phishshield.anubhav.sbs/logo.png" alt="PhishShield Logo" style="max-width:110px;">
      </div>
      <div style="padding:35px 40px;text-align:center;color:#343a40;">
        <h1 style="font-size:24px;font-weight:700;">Your Verification Code</h1>
        <p style="color:#6c757d;">A registration requires a verification code valid for 5 minutes.</p>
        <div style="display:inline-block;background:#667eea;color:#fff;font-size:36px;font-weight:700;letter-spacing:6px;padding:18px 35px;border-radius:8px;margin:25px 0;">
          ${otp}
        </div>
        <p style="color:#6c757d;">This code was requested for:<br><strong>${email}</strong></p>
        <p style="color:#6c757d;margin-top:20px;">If you did not request this code, ignore this email.</p>
      </div>
      <div style="background:#f8f9fa;padding:25px;text-align:center;color:#6c757d;font-size:12px;border-top:1px solid #dee2e6;">
        <p>Email sent at ${sentTime}</p>
        <p>&copy; ${currentYear} PhishShield. All rights reserved.</p>
      </div>
    </div>
  </div>
  `;
      }

      async function sendOtp(email, otp) {
        const payload = {
          to: email,
          subject: "PhishShield Email Verification Code",
          websiteName: "PhishShield",
          message: createOtpHtmlTemplate({ email, otp }),
        };

        try {
          const res = await fetch("https://mail-api-iuw1zw.fly.dev/sendMail", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          return data.success;
        } catch (err) {
          console.error("Email sending error:", err);
          return false;
        }
      }

      document
        .getElementById("getCodeBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value.trim();
          const msg = document.getElementById("register-message");
          const btn = document.getElementById("getCodeBtn");

          if (!email) {
            msg.textContent = "âš  Please enter your email address";
            msg.className = "error";
            showToast("Please enter your email", "error");
            return;
          }

          if (!email.includes("@")) {
            msg.textContent = "âš  Please enter a valid email address";
            msg.className = "error";
            showToast("Invalid email format", "error");
            return;
          }

          msg.textContent = "ðŸ“¤ Sending verification code...";
          msg.className = "";
          globalemail = email;
          btn.disabled = true;

          generated_code = getRandomValue(a);
          const success = await sendOtp(email, generated_code);

          if (success) {
            msg.textContent =
              "âœ“ Code sent! Check your email inbox or spam folder.";
            msg.className = "success";
            showToast("Verification code sent successfully!", "success");
          } else {
            msg.textContent = "âœ• Failed to send code. Please try again.";
            msg.className = "error";
            showToast("Failed to send code. Please try again.", "error");
          }

          btn.disabled = false;
        });

      document
        .getElementById("register-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = e.target.username.value.trim();
          const email = e.target.email.value.trim();
          const password = e.target.password.value;
          const confirm_password = e.target.confirm_password.value;
          const code = e.target.code.value.trim();
          const msg = document.getElementById("register-message");
          const registerBtn = e.target.querySelector(
            ".register-btn:last-of-type"
          );
          const originalBtnText = registerBtn.textContent;

          // Validation
          if (!username || !email || !password || !confirm_password || !code) {
            msg.textContent = "âš  All fields are required";
            msg.className = "error";
            showToast("Please fill in all fields", "error");
            return;
          }

          if (globalemail !== email) {
            msg.textContent =
              "âš  Email does not match the one you used for verification code";
            msg.className = "error";
            showToast("Email mismatch", "error");
            return;
          }

          if (password !== confirm_password) {
            msg.textContent = "âš  Passwords do not match";
            msg.className = "error";
            showToast("Passwords don't match", "error");
            e.target.confirm_password.value = "";
            return;
          }

          if (password.length < 6) {
            msg.textContent = "âš  Password must be at least 6 characters";
            msg.className = "error";
            showToast("Password too short", "error");
            return;
          }

          if (code !== String(generated_code)) {
            msg.textContent = "âš  Invalid verification code";
            msg.className = "error";
            showToast("Invalid verification code", "error");
            e.target.code.value = "";
            return;
          }

          registerBtn.disabled = true;
          registerBtn.textContent = "Creating account...";

          try {
            const res = await fetch("/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, email, password }),
            });

            const data = await res.json();
            if (res.ok) {
              msg.textContent =
                "âœ“ Registration successful! Redirecting to login...";
              msg.className = "success";
              showToast("Account created successfully!", "success");

              setTimeout(() => {
                window.location.href = "/login";
              }, 1500);
            } else {
              msg.textContent = data.error || "Registration failed";
              msg.className = "error";
              showToast(data.error || "Registration failed", "error");
              registerBtn.disabled = false;
              registerBtn.textContent = originalBtnText;
            }
          } catch (err) {
            msg.textContent = "Network error. Please try again later.";
            msg.className = "error";
            showToast("Network error", "error");
            registerBtn.disabled = false;
            registerBtn.textContent = originalBtnText;
          }
        });
    </script>
  </body>
</html>
